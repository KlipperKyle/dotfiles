#!/bin/bash
#
# boostrap
#
# Simlink and copy stuff.  This script attempts to do 80% of the work
# for you.
#

DOTFILES="$HOME/dotfiles"
DIFFTOOL="${DIFFTOOL:-vimdiff}"
cd "$HOME"

link() {
    local src="$1"
    local dst="$2"

    # If the file exists but is not a symlink, back it up
    if [[ -e "$dst" && ! -L "$dst" ]] ; then
        # Only backup files that differ
        # This check always succeeds on directories
        # (i.e. directories are always considered unique)
        if ! cmp -s "$src" "$dst" ; then
            echo "$dst: backing up to $dst.dotfilesbak"
            mv "$dst" "$dst.dotfilesbak"
        else
            rm "$dst"
        fi
    fi

    # Symlink it
    echo "$dst: linking from $src"
    ln -nsf "$src" "$dst"
}

copy() {
    local src="$1"
    local dst="$2"
    local ans=

    # If file exists, ask if we want to merge changes
    if [ -e "$dst" ] ; then
        if ! cmp -s "$src" "$dst" ; then
            echo -ne "$dst: differs from '$src'.  Merge changes? [Y/n]: "
            read ans
            if [[ "$ans" != "n" && "$ans" != "N" ]] ; then
                "$DIFFTOOL" "$dst" "$src"
            fi
        else
            echo "$dst: No changes"
        fi
    else
        echo "$dst: copying from $src"
        cp -p "$src" "$dst"
    fi
}

# Simple config files
link "dotfiles/alias" ".alias"
link "dotfiles/env" ".env"
link "dotfiles/emacs" ".emacs"
link "dotfiles/Xresources" ".Xresources"
copy "dotfiles/xautorun" ".xautorun"

# Vim
link "dotfiles/vimrc" ".vimrc"
link "dotfiles/vim" ".vim"

# bin
[ -d "bin" ] || mkdir "bin"
link "../dotfiles/bin/cht" "bin/cht"
link "../dotfiles/bin/chte" "bin/chte"
link "../dotfiles/bin/decrypt" "bin/decrypt"
link "../dotfiles/bin/encrypt" "bin/encrypt"
link "../dotfiles/bin/fix-permissions" "bin/fix-permissions"
link "../dotfiles/bin/slacklock" "bin/slacklock"
link "../dotfiles/bin/pull-seamonkey.sh" "bin/pull-seamonkey.sh"
link "../dotfiles/bin/pull-vimwiki.sh" "bin/pull-vimwiki.sh"
link "../dotfiles/bin/pull-zotero.sh" "bin/pull-zotero.sh"
link "../dotfiles/bin/push-seamonkey.sh" "bin/push-seamonkey.sh"
link "../dotfiles/bin/push-vimwiki.sh" "bin/push-vimwiki.sh"
link "../dotfiles/bin/push-zotero.sh" "bin/push-zotero.sh"
link "../dotfiles/bin/sshfs-helper" "bin/sshfs-helper"

# Git
copy "dotfiles/gitconfig" ".gitconfig"
